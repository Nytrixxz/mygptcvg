<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Audio Room â€” Demo</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:0;padding:24px;background:#0f172a;color:#e6eef8}
    .card{background:linear-gradient(135deg,#0b1220,#111827);padding:20px;border-radius:12px;max-width:720px;margin:auto;box-shadow:0 6px 30px rgba(2,6,23,.6)}
    h1{margin:0 0 12px;font-size:20px}
    .row{display:flex;gap:8px;margin-bottom:12px}
    input,button,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit}
    button{cursor:pointer}
    .peers{margin-top:12px;font-size:14px}
    .big{font-size:16px;padding:12px 16px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Simple Audio Room (WebRTC)</h1>
    <div class="row">
      <input id="signalUrl" placeholder="Signaling server (wss://...)" value="wss://mygptcvg.onrender.com/ws" style="flex:1"/>
      <input id="room" placeholder="Room name" value="room1" />
      <input id="name" placeholder="Your name" value="friend" />
      <button id="connectBtn">Connect</button>
    </div>

    <div class="row">
      <button id="joinBtn" class="big" disabled>Join Room</button>
      <button id="callBtn" class="big" disabled>Start Call</button>
      <button id="muteBtn" class="big" disabled>Mute</button>
    </div>

    <div class="peers" id="log">Status: Idle</div>
  </div>

<script>
let ws = null;
let pc = null;
let localStream = null;
let audioEl = document.createElement('audio');
audioEl.autoplay = true;
audioEl.controls = false;
audioEl.style.display = 'none';
document.body.appendChild(audioEl);

const SIGNAL_DEFAULT = document.getElementById('signalUrl').value;

function log(msg){
  document.getElementById('log').innerText = 'Status: ' + msg;
}

document.getElementById('connectBtn').onclick = async ()=>{
  const url = document.getElementById('signalUrl').value.trim();
  if(!url){ alert('enter signaling ws url'); return; }
  ws = new WebSocket(url);
  ws.onopen = ()=>{ log('Connected to signaling'); document.getElementById('joinBtn').disabled = false; };
  ws.onmessage = async (ev)=>{
    const data = JSON.parse(ev.data);
    if(data.action === 'signal'){
      // incoming offer/answer/ice
      const payload = data.data;
      if(payload.type === 'offer' || payload.type === 'answer'){
        await pc.setRemoteDescription(payload);
        if(payload.type === 'offer'){
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({action:'signal', room:roomName, from:myName, data: pc.localDescription}));
        }
      } else if(payload.candidate){
        try { await pc.addIceCandidate(payload); } catch(e){ console.warn('ice add failed', e); }
      }
    } else if(data.action === 'peer-joined'){
      log('Peer joined: ' + data.name);
    } else if(data.action === 'peer-left'){
      log('Peer left: ' + data.name);
    }
  };
  ws.onerror = (e)=> log('WS error');
};

let roomName = null;
let myName = null;

document.getElementById('joinBtn').onclick = async ()=>{
  if(!ws || ws.readyState !== WebSocket.OPEN){ alert('Connect to signaling first'); return; }
  roomName = document.getElementById('room').value || 'room1';
  myName = document.getElementById('name').value || 'anon';
  ws.send(JSON.stringify({action:'join', room: roomName, name: myName}));
  document.getElementById('callBtn').disabled = false;
  document.getElementById('muteBtn').disabled = false;
  log('Joined room ' + roomName);
};

document.getElementById('callBtn').onclick = async ()=>{
  if(!ws) return;
  // create RTCPeerConnection
  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
  pc = new RTCPeerConnection(config);
  pc.onicecandidate = (ev)=> {
    if(ev.candidate){
      ws.send(JSON.stringify({action:'signal', room: roomName, from: myName, data: {candidate: ev.candidate}}));
    }
  };
  pc.ontrack = (ev)=> {
    // play remote audio
    audioEl.srcObject = ev.streams[0];
    audioEl.play().catch(()=>{});
    log('Receiving audio');
  };

  // get local audio
  try{
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    // add each track
    for(const t of localStream.getAudioTracks()) pc.addTrack(t, localStream);
  }catch(e){
    alert('Microphone access denied or error: ' + e);
    return;
  }

  // create offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  // send to others via signaling
  ws.send(JSON.stringify({action:'signal', room: roomName, from: myName, data: pc.localDescription}));
  log('Call started (offer sent)');
};

let muted = false;
document.getElementById('muteBtn').onclick = ()=>{
  if(!localStream) return;
  muted = !muted;
  for(const t of localStream.getAudioTracks()) t.enabled = !muted;
  document.getElementById('muteBtn').innerText = muted ? 'Unmute' : 'Mute';
};
</script>
</body>
</html>
